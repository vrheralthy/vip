<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VIP Registration Completed</title>
  <meta name="theme-color" content="#16a34a" />
  <style>
    :root{--bg:#0b0f14;--card:#0f1720;--text:#e8f0f7;--muted:#8aa0b4;--primary:#16a34a;--primary-2:#22c55e;--border:#16212c;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;display:grid;place-items:center;padding:24px;background:
      radial-gradient(1200px 600px at 80% -10%, #17324a 0%, transparent 60%),
      radial-gradient(900px 500px at -10% 110%, #123b28 0%, transparent 60%),var(--bg);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text)}
    .card{max-width:560px;padding:32px;text-align:center;border-radius:var(--radius);border:1px solid var(--border);
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)),var(--card);box-shadow:var(--shadow)}
    h1{font-size:26px;margin:0 0 10px} p{margin:0 0 18px;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 18px;border-radius:14px;font-weight:600;text-decoration:none;cursor:pointer;border:1px solid transparent;transition:.2s}
    .btn-primary{background:linear-gradient(180deg,var(--primary-2),var(--primary));color:#06240f;border-color:#22c55e;box-shadow:0 6px 20px rgba(34,197,94,.35)}
    .btn-primary:hover{filter:brightness(1.05)}
    .spinner{width:20px;height:20px;border-radius:50%;border:3px solid rgba(255,255,255,.15);border-top-color:#93c5fd;animation:spin 1s linear infinite;margin:16px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="card">
    <h1>✅ สมัครสมาชิกเรียบร้อย</h1>
    <p>ขอบคุณที่เข้าร่วมเป็น VIP กับเรา ระบบจะพาคุณกลับไปที่แชท @vreasyhealthy</p>
    <div class="spinner"></div>
    <a id="btnBack" class="btn btn-primary" href="https://line.me/R/ti/p/@vreasyhealthy" rel="noopener">กลับไปที่ OA ทันที</a>
  </div>

<script>
  /* ========= CONFIG ========= */
  const LIFF_ID    = "2007996778-ojPmjnww";
  const OA_URL     = "https://line.me/R/ti/p/@vreasyhealthy";
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxrIR6CdO-saT-5wcSznL99LJVL3sL0QSdD6cPmXBV86cCAWIEkj69ztTVbZPxchLE/exec";
  const APP_TOKEN  = "vRH-2025-ProdSecret";  // <— แก้ให้ตรงกับ Script properties

  /* ========= LOGGING (safe) ========= */
  function logSend(data){
    const payload = JSON.stringify(data);
    try{
      if (navigator.sendBeacon) {
        const blob = new Blob([payload], { type: 'text/plain' });
        navigator.sendBeacon(WEBAPP_URL, blob);
        return;
      }
    }catch(e){}
    fetch(WEBAPP_URL, { method:'POST', body: payload, mode:'no-cors', keepalive:true }).catch(()=>{});
  }
  async function logEventDone(profile){
    logSend({
      token: APP_TOKEN,
      event: 'vip_register_done',
      liffId: LIFF_ID,
      userId: profile?.userId || '',
      displayName: profile?.displayName || '',
      pictureUrl: profile?.pictureUrl || '',
      statusMessage: profile?.statusMessage || '',
      friendFlag: true,
      sourcePage: 'done.html',
      referrer: document.referrer || '',
      returnUrl: OA_URL,
      userAgent: navigator.userAgent,
      origin: location.origin,
      extra: { href: location.href }
    });
  }

  /* ========= OA GREETING ========= */
  async function sendThanks(profile){
    try{
      if (!liff.isInClient()) return;
      const name = profile?.displayName ? ` (${profile.displayName})` : '';
      await liff.sendMessages([
        { type: 'text', text: `ลงทะเบียน VIP สำเร็จค่ะ${name}` },
        { type: 'text', text: `ต้องการคำแนะนำการใช้งานสินค้าตัวไหน แจ้งได้เลยค่ะ` }
      ]);
    }catch(e){}
  }

  /* ========= MAIN ========= */
  (async () => {
    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
      const profile = await liff.getProfile().catch(()=> ({}));
      logEventDone(profile);
      await sendThanks(profile);

      const goBack = () => { if (liff.isInClient()) liff.closeWindow(); else window.location.href = OA_URL; };
      document.getElementById('btnBack').onclick = goBack;
      setTimeout(goBack, 2000);
    }catch(e){
      setTimeout(()=>window.location.href = OA_URL, 2500);
    }
  })();
</script>
</body>
</html>
